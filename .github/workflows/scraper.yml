name: Tender Scraper with AI Analysis
on:
  # Run daily at 9:00 AM UTC (11:00 AM Sofia time)
  schedule:
    - cron: '30 21 * * *'
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:
  
  # Run on push to main branch (for testing)
 # push:
 #   branches: [ main ]

permissions:
  contents: write

jobs:
  scrape-tenders:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Step 2: Set up Python
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # Step 3: Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install playwright rich google-generativeai pandas
          playwright install chromium
          playwright install-deps chromium
      
      # Step 4: Run the scraper with AI analysis
      - name: Run tender scraper with Gemini AI
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        run: |
          python scraper.py
      
      # Step 5: Upload JSON results as artifact
      - name: Upload tender data
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tenders-data-${{ github.run_number }}
          path: tenders_data.json
          retention-days: 30
      
      # Step 6: Upload AI analysis as artifact
      - name: Upload AI analysis
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: it-analysis-${{ github.run_number }}
          path: it_tender_analysis_*.txt
          retention-days: 30
      
      # Step 7: Commit and push results to repository
      - name: Commit results to repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Create data directory if it doesn't exist
          mkdir -p data/analyses
          
          # Copy with timestamp
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          cp tenders_data.json data/tenders_${TIMESTAMP}.json
          
          # Also keep latest version
          cp tenders_data.json data/tenders_latest.json
          
          # Copy AI analysis if it exists
          if ls it_tender_analysis_*.txt 1> /dev/null 2>&1; then
            cp it_tender_analysis_*.txt data/analyses/analysis_${TIMESTAMP}.txt
            cp it_tender_analysis_*.txt data/analyses/analysis_latest.txt
          fi
          
          # Commit if there are changes
          git add data/
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update tenders data and AI analysis - $(date +'%Y-%m-%d %H:%M:%S')" && git push)
      
      # Step 8: Create detailed summary with IT analysis
      - name: Create job summary
        if: always()
        run: |
          echo "## ðŸ¤– Tender Scraper Results with AI Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f tenders_data.json ]; then
            TOTAL=$(jq '.metadata.total_tenders' tenders_data.json)
            SKIPPED=$(jq '.metadata.skipped_old_tenders' tenders_data.json)
            PAGES=$(jq '.metadata.pages_processed' tenders_data.json)
            
            echo "### ðŸ“Š Scraping Summary" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… **Total Tenders Extracted:** $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- âŠ— **Old Tenders Skipped:** $SKIPPED" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“„ **Pages Processed:** $PAGES" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Count IT-related tenders (simple keyword search)
            IT_COUNT=$(jq '[.tenders[] | select(.tender_objective + .documentation | ascii_downcase | test("Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¾Ð½Ð½|ÑÐ¾Ñ„Ñ‚ÑƒÐµÑ€|Ñ…Ð°Ñ€Ð´ÑƒÐµÑ€|ÐºÐ¾Ð¼Ð¿ÑŽÑ‚ÑŠÑ€|ÑÑŠÑ€Ð²ÑŠÑ€|Ð¼Ñ€ÐµÐ¶Ð°|ÑÐ¸ÑÑ‚ÐµÐ¼Ð°|it|ÑÐ¾Ñ„Ñ‚ÑƒÐµÑ€Ð½"))] | length' tenders_data.json)
            echo "- ðŸ’» **IT-Related Tenders Found:** $IT_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### ðŸ“‹ Latest Tenders (First 3)" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            jq '.tenders[0:3] | .[] | {order_number, tender_objective, estimated_amount, submission_deadline: .submission_deadline.formatted}' tenders_data.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Error:** tenders_data.json not found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Add AI analysis summary if available
          if ls it_tender_analysis_*.txt 1> /dev/null 2>&1; then
            echo "### ðŸ¤– AI Analysis Highlights" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**AI Analysis completed successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Preview (first 50 lines):" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -50 it_tender_analysis_*.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Ž Full analysis available in artifacts" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ AI Analysis" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "AI analysis file not found. Check logs for errors." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ Download artifacts for complete data and analysis" >> $GITHUB_STEP_SUMMARY
